{% load i18n %}
{% load static %}
{% get_current_language as CURRENT_LANG %}
{% get_available_languages as LANGUAGES %}
{% get_language_info_list for LANGUAGES as languages %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="{% static 'stylesheets/index/index_desktop.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'stylesheets/components/footer.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'stylesheets/components/language_picker.css' %}"/>
    <link rel="shortcut icon" type="image/png" href="{% static 'images/we-book-icon.ico' %}">

    <!-- Include jQuery -->
    {#    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>#}
    {##}
    {#    <!-- Include jQuery UI CSS and JavaScript -->#}
    {#    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">#}
    {#    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>#}
    <link href="http://code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="http://code.jquery.com/ui/1.11.3/jquery-ui.min.js"></script>


    <title>Title</title>
</head>
<body>

<div class="page-container">
    <div class="form-div">
        <form action="./make_reservation?restaurantID={{ restaurant.id }}" method="post" class="form_main">
            {% csrf_token %}
            <p class="heading">{% trans "reserve_table" %} {{ restaurant.name }}</p>
            <div class="inputContainer">
                <svg class="inputIcon bi bi-person" xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                     fill="currentColor"
                     viewBox="0 0 16 16">
                    <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"></path>
                </svg>


                <input type="number" class="inputField" id="number_of_persons" placeholder="{% trans "no_persons" %}"
                       name="number_of_persons">
            </div>

            <div class="inputContainer">
                <svg class="inputIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 48 48">
                    <!-- Calendar Outline -->
                    <rect x="6" y="8" width="36" height="32" fill="none" stroke="#000" stroke-width="2"></rect>
                    <line x1="6" y1="16" x2="42" y2="16" fill="none" stroke="#000" stroke-width="2"></line>
                    <line x1="6" y1="24" x2="42" y2="24" fill="none" stroke="#000" stroke-width="2"></line>
                    <line x1="6" y1="32" x2="42" y2="32" fill="none" stroke="#000" stroke-width="2"></line>

                    <!-- Calendar Day Indicators -->
                    <circle cx="11" cy="13" r="2" fill="#000"></circle>
                    <circle cx="24" cy="13" r="2" fill="#000"></circle>
                    <circle cx="37" cy="13" r="2" fill="#000"></circle>
                </svg>


                {#                <input type="date" class="inputField" id="reservation_date" name="reservation_date"#}
                {#                       placeholder="{% trans "reservation_date" %}">#}
                <input class="inputField" type="text" id="datepicker" placeholder="Select a date" name="reservation_date">

            </div>

            <div class="inputContainer">
                <svg class="inputIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 48 48">
                    <!-- Clock Face -->
                    <circle cx="24" cy="24" r="22" fill="none" stroke="#000" stroke-width="2"></circle>

                    <!-- Clock Hand -->
                    <path fill="none" stroke="#000" stroke-width="2" d="M24 12v13h10"></path>

                    <!-- Clock Numbers -->
                    <text x="24" y="40" font-size="6" fill="#000" text-anchor="middle">12</text>
                    <text x="36" y="28" font-size="6" fill="#000" text-anchor="middle">3</text>
                    <text x="24" y="6" font-size="6" fill="#000" text-anchor="middle">6</text>
                    <text x="12" y="28" font-size="6" fill="#000" text-anchor="middle">9</text>
                </svg>


                {#                <input type="time" class="inputField" id="reservation_time" name="reservation_time"#}
                {#                       placeholder="{% trans "reservation_time" %}">#}
                <select class="inputField" name="reservation_time" id="timeSlotSelect">

                </select>
            </div>

            <button class="submit-button" id="button">Submit</button>


            <div class="language-picker-div">
                {% include 'components/language_picker.html' %}
            </div>


        </form>

    </div>
    {% include 'components/footer.html' %}
</div>

<script>
    //JSON INPUTS
    //Dates to be disabled (format: ["23-09-2023", "24-09-2023", "26-09-2023", "27-09-2023"])
    const disable_datesdata = new DOMParser().parseFromString("{{ json_disable_datesdata }}", "text/html");
    const disable_datesdata_to_parse = disable_datesdata.documentElement.textContent
    const parsed_disable_datesdata = JSON.parse(disable_datesdata_to_parse)
    var disableddates = parsed_disable_datesdata
    //Timeslot availability per date (dict)
    const availability = new DOMParser().parseFromString("{{ availability }}", "text/html");
    const availability_data_to_parse = availability.documentElement.textContent
    const parsed_availability_data = JSON.parse(availability_data_to_parse)
    console.log(parsed_availability_data)

    //FUNCTIONS
    function toggleTimeslots(selectedDate) {
        console.log("Selected date: " + selectedDate);
        const dateObject = new Date(selectedDate);
        const year = dateObject.getFullYear().toString();
        const month = (dateObject.getMonth() + 1).toString().padStart(2, '0');
        const day = dateObject.getDate().toString().padStart(2, '0');
        const formattedDate = year + "-" + month + "-" + day;
        console.log(formattedDate)
        timeSlotAvailability = parsed_availability_data[formattedDate];
        console.log(timeSlotAvailability)
        updateTimeSlotAvailability(timeSlotAvailability)
    }

    function DisableSpecificDates(date) {
        var string = jQuery.datepicker.formatDate('yy-mm-dd', date);
        return [disableddates.indexOf(string) === -1];
    }

    function updateTimeSlotAvailability(timeSlotAvailability) {
        const selectElement = document.getElementById('timeSlotSelect');

        for (const timeSlot in timeSlotAvailability) {
            console.log(timeSlot)
            const optionElement = selectElement.querySelector(`option[value="${timeSlot}"]`);

            if (optionElement) {
                if (timeSlotAvailability[timeSlot] === 'disabled') {
                    optionElement.disabled = true;
                } else {
                    optionElement.disabled = false;
                }
            }
        }
    }

    //EVENT LISTENERS AND EMITTERS
    $(function () {
        $("#datepicker").datepicker({
            beforeShowDay: DisableSpecificDates,
            onSelect: function (selectedDate) {
                toggleTimeslots(selectedDate)
            },
            dateFormat: "dd/mm/yy"
        });
    });

</script>

<script>
    function populateTimeSlots() {
        const selectElement = document.getElementById('timeSlotSelect');
        for (let hour = 0; hour <= 24; hour++) {
            for (let minute = 0; minute < 60; minute += 15) {
                const hourFormatted = String(hour).padStart(2, '0');
                const minuteFormatted = String(minute).padStart(2, '0');
                const timeSlot = `${hourFormatted}:${minuteFormatted}`;

                const optionElement = document.createElement('option');
                optionElement.value = timeSlot;
                optionElement.textContent = `${hourFormatted}:${minuteFormatted}`;

                selectElement.appendChild(optionElement);
            }
        }
    }

    // Call the function to populate the time slots
    populateTimeSlots();
</script>

</body>
</html>